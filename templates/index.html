<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Germanbot - German Learning Chatbot</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
    /* Premium color palette - Modern & Inviting */
    body {
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: "Poppins", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        user-select: none;
        min-height: 100vh;
    }

    .chat-container {
        width: 600px;
        height: 800px;
        background: #ffffff;
        border-radius: 28px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: none;
        transition: all 0.3s ease;
    }

    .chat-container:hover {
        box-shadow: 0 35px 80px rgba(0, 0, 0, 0.35);
        transform: translateY(-5px);
    }

    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px 20px;
        text-align: center;
        font-size: 24px;
        font-weight: 800;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        user-select: text;
        letter-spacing: 0.5px;
    }

    .header svg {
        width: 30px;
        height: 30px;
        fill: white;
        filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
        animation: pulse 2s infinite alternate;
    }

    @keyframes pulse {
        from { opacity: 0.7; }
        to { opacity: 1; }
    }

    .messages {
        flex: 1;
        padding: 24px 28px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
        scroll-behavior: smooth;
        background: linear-gradient(180deg, #ffffff 0%, #f8f9ff 100%);
    }

    .messages::-webkit-scrollbar {
        width: 8px;
    }

    .messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
        background: #ddd;
        border-radius: 4px;
    }

    .msg {
        max-width: 85%;
        padding: 14px 18px;
        border-radius: 20px;
        font-size: 15px;
        line-height: 1.6;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        opacity: 0;
        transform: translateY(10px);
        animation: slideIn 0.3s ease-out forwards;
        word-wrap: break-word;
    }

    @keyframes slideIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .user {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 6px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
        font-weight: 500;
    }

    .bot {
        background: #f0f0f7;
        color: #1a1a2e;
        align-self: flex-start;
        border-bottom-left-radius: 6px;
        display: flex;
        align-items: flex-start;
        gap: 14px;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        padding: 14px 18px;
    }

    .msg-content {
        flex: 1;
        white-space: pre-wrap;
    }

    .speaker-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        cursor: pointer;
        font-size: 13px;
        padding: 9px 14px;
        min-width: auto;
        border-radius: 12px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
        font-weight: 600;
        position: relative;
        flex-shrink: 0;
        white-space: nowrap;
    }

    .speaker-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        background: linear-gradient(135deg, #7a8ef5 0%, #8456b8 100%);
    }

    .speaker-btn:active {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
    }

    .speaker-btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2), 0 4px 12px rgba(102, 126, 234, 0.35);
    }

    .input-area {
        display: flex;
        padding: 18px 24px;
        gap: 12px;
        background: linear-gradient(180deg, #f8f9ff 0%, #f0f0f7 100%);
        border-top: 1px solid #e5e7f0;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
    }

    input {
        flex: 1;
        padding: 14px 18px;
        border-radius: 18px;
        border: 2px solid #e5e7f0;
        font-size: 15px;
        transition: all 0.2s ease;
        outline: none;
        font-weight: 500;
        color: #1a1a2e;
        user-select: text;
        font-family: "Poppins", sans-serif;
    }

    input::placeholder {
        color: #a0a0b0;
        font-weight: 400;
    }

    input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
        background: #ffffff;
    }

    #msgInput {
        background: #ffffff;
    }

    button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 18px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 700;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;
        box-shadow: 0 4px 14px rgba(102, 126, 234, 0.35);
        white-space: nowrap;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.5);
        background: linear-gradient(135deg, #7a8ef5 0%, #8456b8 100%);
    }

    button:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2), 0 4px 14px rgba(102, 126, 234, 0.35);
    }
    
    .loading {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 15px;
        color: #5a5a6a;
        font-style: italic;
        padding-left: 22px;
        user-select: none;
        font-weight: 500;
    }

    .loading-dots {
        display: inline-flex;
        gap: 6px;
    }

    .loading-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #6f89ff;
        animation: bounce 1.4s infinite;
    }

    .loading-dot:nth-child(2) {
        animation-delay: 0.25s;
    }

    .loading-dot:nth-child(3) {
        animation-delay: 0.5s;
    }

    @keyframes bounce {
        0%, 100% { opacity: 0.35; transform: translateY(0); }
        50% { opacity: 1; transform: translateY(-12px); }
    }

    .hidden {
        display: none;
    }
</style>
</head>

<body>
<div class="chat-container">
    <div class="header">Germanbot - Learn German</div>

    <div class="messages" id="messages"></div>

    <div id="loadingIndicator" class="loading hidden">
        <span>ChatBot is typing</span>
        <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
        </div>
    </div>

    <div class="input-area">
        <input id="msgInput" placeholder="Type your message..." onkeydown="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
let currentUtterance = null;
let isPaused = false;
let currentText = "";
let currentSpeakerBtn = null;
let selectedVoice = null;

// Select ONE consistent voice that handles both English and German
function selectUniversalVoice() {
    return new Promise((resolve) => {
        let voices = window.speechSynthesis.getVoices();
        if (voices.length === 0) {
            window.speechSynthesis.onvoiceschanged = () => {
                voices = window.speechSynthesis.getVoices();
                resolve(chooseBestVoice(voices));
            };
        } else {
            resolve(chooseBestVoice(voices));
        }
    });
}

// Choose ONE best voice that works for both languages
function chooseBestVoice(voices) {
    // Prioritize Google voices as they're usually the best quality and multilingual
    let googleVoices = voices.filter(v => v.name.includes("Google"));
    if (googleVoices.length > 0) {
        // Prefer German Google voice for better pronunciation
        const germanGoogle = googleVoices.find(v => v.lang.startsWith("de"));
        if (germanGoogle) return germanGoogle;
        // Otherwise any Google voice
        return googleVoices[0];
    }

    // Fallback to German voice
    const germanVoice = voices.find(v => v.lang.startsWith("de"));
    if (germanVoice) return germanVoice;

    // Last resort
    return voices[0] || null;
}

async function initializeVoice() {
    selectedVoice = await selectUniversalVoice();
    console.log('Voice initialized:', selectedVoice ? selectedVoice.name : 'Default voice');
}

// Initialize voice on page load
initializeVoice();

async function sendMessage() {
    const input = document.getElementById("msgInput");
    const message = input.value.trim();
    if (!message) return;

    addMessage(message, "user");
    input.value = "";

    const loadingIndicator = document.getElementById("loadingIndicator");
    loadingIndicator.classList.remove("hidden");

    try {
       const res = await fetch("/chat", {
           method: "POST", 
           headers: { "Content-Type": "application/json" }, 
           body: JSON.stringify({ message })
           });    

        const data = await res.json();
        addMessage(data.response, "bot");

    } catch (error) {
        addMessage("Error connecting to server.", "bot");
    } finally {
        loadingIndicator.classList.add("hidden");
    }
}

function addMessage(text, type) {
    const msgBox = document.createElement("div");
    msgBox.className = `msg ${type}`;

    if (type === "bot") {
        const content = document.createElement("div");
        content.className = "msg-content";

        // Format bot reply text with line breaks and bullets preserved
        const lines = text.split("\n").map(line => line.trim());
        const formattedText = lines.join("<br>");
        content.innerHTML = formattedText;

        const speakerBtn = document.createElement("button");
        speakerBtn.className = "speaker-btn";
        speakerBtn.innerHTML = "▶️";
        speakerBtn.title = "Play audio";
        speakerBtn.onclick = () => toggleSpeech(text, speakerBtn);

        msgBox.appendChild(content);
        msgBox.appendChild(speakerBtn);
    } else {
        msgBox.textContent = text;
    }

    const messagesDiv = document.getElementById("messages");
    messagesDiv.appendChild(msgBox);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/**
 * Toggles speech playback for the given text and button.
 * Starts new speech if text differs from current, otherwise toggles pause/resume.
 */
function toggleSpeech(text, btn) {
    if (!text || !btn) return;
  
    // Check if this is a different message (different button clicked)
    const isDifferentMessage = (currentSpeakerBtn !== btn) || (currentText !== text);
    
    if (isDifferentMessage) {
        // New message clicked, stop any current speech and start new
        stopSpeech();
        startSpeech(text, btn);
    } else {
        // Same message clicked, toggle pause/resume
        if (isPaused) {
            resumeSpeech(btn);
        } else if (window.speechSynthesis.speaking) {
            pauseSpeech(btn);
        } else {
            // If speech finished or stopped, start speech again
            startSpeech(text, btn);
        }
    }
}

/**
 * Unified button state update to ensure consistent appearance
 */
function updateButtonState(btn, isPlaying) {
    if (!btn) return;
    
    if (isPlaying) {
        btn.innerHTML = "⏸️ Pause";
        btn.title = "Pause audio";
        btn.setAttribute('aria-label', 'Pause audio');
    } else {
        btn.innerHTML = "▶️ Play";
        btn.title = "Play audio";
        btn.setAttribute('aria-label', 'Play audio');
    }
}

/**
 * Extracts clean text from bot response, removing bullets, special chars, and formatting
 */
function extractCleanText(text) {
    // Remove bullet points and arrows while preserving actual text
    let cleanText = text
        .replace(/•/g, '')      // Remove bullet points
        .replace(/→/g, '')      // Remove arrows
        .replace(/\[.*?\]/g, '') // Remove bracketed hints
        .split('\n')
        .map(line => {
            // Remove leading dashes from each line
            return line.replace(/^\s*-\s*/gm, '').trim();
        })
        .filter(line => line.length > 0 && line.trim() !== '')
        .join('. ');
    
    // Clean up extra spaces
    cleanText = cleanText.replace(/\s+/g, ' ').trim();
    
    return cleanText;
}

/**
 * Detects language for proper pronunciation
 */
function detectLanguage(text) {
    const germanWords = /\b(ich|der|die|das|ein|eine|und|zu|nicht|ist|haben|sein|guten|tag|hallo|danke|bitte|drei|elf|zwanzig|eins|zwei|grün|rot|blau)\b/gi;
    return germanWords.test(text) ? 'de-DE' : 'en-US';
}

/**
 * Starts speech synthesis for the given text with ONE consistent voice
 */
function startSpeech(text, btn) {
    // Cancel any existing speech
    window.speechSynthesis.cancel();
    
    currentUtterance = null;
    isPaused = false;
    currentText = text;
    currentSpeakerBtn = btn;
    
    // Update button immediately
    updateButtonState(btn, true);
    
    const cleanedText = extractCleanText(text);
    const language = detectLanguage(cleanedText);
    
    const utterance = new SpeechSynthesisUtterance(cleanedText);
    
    // Use the same universal voice for all text
    if (selectedVoice) {
        utterance.voice = selectedVoice;
    }
    
    // Set language for proper pronunciation but keep same voice
    utterance.lang = language;
    utterance.rate = 0.85;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    currentUtterance = utterance;
    
    utterance.onend = () => {
        resetSpeechState();
    };
    
    utterance.onerror = (e) => {
        console.error('Speech error:', e);
        resetSpeechState();
    };
    
    window.speechSynthesis.speak(utterance);
}

/**
 * Pauses ongoing speech synthesis, updates UI and internal state.
 */
function pauseSpeech(btn) {
    // Make sure this is the current button and speech is actually playing
    if (btn === currentSpeakerBtn && (window.speechSynthesis.speaking || currentUtterance)) {
        window.speechSynthesis.pause();
        isPaused = true;
        updateButtonState(btn, false);
    }
}

/**
 * Resumes paused speech synthesis, updates UI and internal state.
 */
function resumeSpeech(btn) {
    // Make sure this is the current button and speech is actually paused
    if (btn === currentSpeakerBtn && window.speechSynthesis.paused) {
        window.speechSynthesis.resume();
        isPaused = false;
        updateButtonState(btn, true);
    }
}

/**
 * Stops any ongoing/paused speech synthesis and resets UI & state.
 */
function stopSpeech() {
    if (window.speechSynthesis.speaking || window.speechSynthesis.paused) {
        window.speechSynthesis.cancel();
    }
    resetSpeechState();
}

/**
 * Resets speech state variables and UI button to default.
 */
function resetSpeechState() {
    currentUtterance = null;
    isPaused = false;
    currentText = "";
    if (currentSpeakerBtn) {
        updateButtonState(currentSpeakerBtn, false);
        currentSpeakerBtn = null;
    }
}
</script>

</body>
</html>
